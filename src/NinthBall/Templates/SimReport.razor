@using System;

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <style>
        .pct-col {
            font-family: monospace;
            white-space: pre; /* Preserves the exact whitespace generated by C# padding */
        }

        .page-break {
            break-before: page; /* same as page-break-before: always */
        }

        .section {
            break-inside: avoid; /* prevents splitting across pages */
        }
    </style>
</head>

<body>
    <div class="container-fluid">

        <!-- Simulation parameters -->
        <div>
        <h4 class="mt-3">
            @($"{InitialBalance:C0}") | @($"{StockAllocationPct:P0}") - @($"{BondAllocationPct:P0}") | @NumYears years | @NumIterations.ToString("#,0") iterations
        </h4>
        <ul>
            @foreach (var obj in Model.Objectives)
            {
                <li>@obj.ToString()</li>
            }
        </ul>
        </div>

        <!-- Survival rate and failures by year -->
        <table class="table table-sm caption-top" style="table-layout: fixed; width: 100%;">
            @{
                var survivalRate = Model.SurvivalRate;
                var txtSurvivalRate = survivalRate > 0.99 && survivalRate < 1.0 ? $"{survivalRate:P1}" : $"{survivalRate:P0}";
                var failureBuckets = GetFailureBuckets().ToList();
            }
            <caption>
                <h3>Survival rate: @txtSurvivalRate</h3>
            </caption>
            <thead>
                <tr>
                    <td>
                        Years:
                    </td>
                    @foreach (var bucket in failureBuckets)
                    {
                        var caption = $"{bucket.From + 1}-{bucket.To + 1}";

                        <td class="text-primary">
                            Years @caption
                        </td>
                    }

                    <td class="text-primary">
                        Total
                    </td>
                </tr>
            </thead>
            <tbody>

                <tr>
                    <th>
                        Failures:
                    </th>
                    @foreach (var bucket in failureBuckets)
                    {
                        var txtFailed = 0 == bucket.NumFailed ? "" : $"{bucket.NumFailed}";
                        <th>@txtFailed</th>
                    }
                    <th>@Failed.Count()</th>
                </tr>
            </tbody>

        </table>

        <!-- Percentils -->
        <table id="percentiles" class="table table-sm caption-top" style="table-layout: fixed; width: 100%;">
            <caption>
                <h3>Percentiles</h3>
            </caption>
            <tbody>
                <tr>
                    <th></th>
                    @foreach (var p in PercentileTargets)
                    {
                        (var label, var id) = GetPercentileLabelAndId(p);
                        <td class="text-primary">
                            @label pctl
                        </td>
                    }
                </tr>
                <tr>
                    <th></th>
                    @foreach (var mood in PercentileSentiments)
                    {
                        <td class="text-secondary">@mood</td>
                    }
                </tr>
                <tr>
                    <th>End (Real)</th>
                    @foreach (var p in PercentileTargets)
                    {
                        var iter = FindIterationByPercentile(p);

                        if (iter.Success)
                        {
                            var endBalance = iter.ByYear[^1].DecBalance.InflationAdjustedValue(TheInflationRate, iter.SurvivedYears).Millions();
                            <th>@endBalance</th>
                        }
                        else
                        {
                            <td class="text-danger">--</td>
                        }
                    }
                </tr>
                <tr>
                    <td>End (Nominal)</td>
                    @foreach (var p in PercentileTargets)
                    {
                        var iter = FindIterationByPercentile(p);
                        
                        if (iter.Success)
                        {
                            var endBalance = iter.ByYear[^1].DecBalance.Millions();
                            <td class="text-secondary">@endBalance</td>
                        }
                        else
                        {
                            <td class="text-danger">--</td>
                        }
                    }
                </tr>
                <tr>
                    <td>Change (Annualized)</td>
                    @foreach (var p in PercentileTargets)
                    {
                        var iter = FindIterationByPercentile(p);
                        var pctChange = iter.ByYear.Select(x => x.PCTChange).ToArray().Annualize();
                        <td class="text-secondary">
                            @($"{pctChange:P1}")
                        </td>
                    }
                </tr>
            </tbody>

        </table>

        <ul class="nav" role="tablist">
            <li class="nav-item">
                <a class="nav-link disabled" aria-disabled="true">Details: </a>
            </li>
            @foreach (var p in PercentileTargets)
            {
                (var pctlLabel, var pctlId) = GetPercentileLabelAndId(p);

                var isActive = p == TargetPctl ? "active" : "";

                <li class="nav-item">
                    <a class="nav-link @isActive" data-bs-toggle="tab" href="#@(pctlId)">@pctlLabel</a>
                </li>
            }
        </ul>

        <div class="tab-content">
            @foreach (var p in PercentileTargets)
            {
                var iter = FindIterationByPercentile(p);
                (var pctlLabel, var pctlId) = GetPercentileLabelAndId(p);

                var isActive = p == TargetPctl ? "active" : "";

                <div class="tab-pane @isActive" id="@(pctlId)">
                    <table id="@(pctlId)-tbl" class="table table-sm caption-top page-break mb-0" style="table-layout: fixed; width: 100%;">
                        <caption>
                            <h3>@pctlLabel Percentile</h3>
                        </caption>
                        <tbody>

                            <!-- Summary on top -->
                            @{
                                var totalFees = iter.ByYear.Sum(y => y.Fees);

                                var xCaption = $"{iter.ByYear.Count} years";

                                var xJan     = iter.ByYear[0].JanBalance.Millions();
                                var xFees    = totalFees.Millions();
                                var xDraw    = iter.ByYear.Sum(y => y.ActualWithdrawal).Millions();
                                var xChange  = iter.ByYear.Sum(y => y.Change).Millions();
                                var xDecReal = iter.ByYear[^1].DecBalance.InflationAdjustedValue(TheInflationRate, iter.SurvivedYears).Millions();

                                var xAlloc = string.Empty;

                                var xLike = string.Empty;
                                var xStock = iter.ByYear.Select(y => y.StockROI).Annualize().ToString("P1").PadLeft(6);
                                var xBond = iter.ByYear.Select(y => y.BondROI).Annualize().ToString("P1").PadLeft(6);
                            }
                            <tr>
                                <td class="text-secondary">@xCaption</td>

                                <td class="text-secondary">@xJan</td>
                                <td class="text-secondary">@xAlloc</td>

                                <td><small class="text-secondary">#@iter.Index</small></td>
                                <td class="text-secondary pct-col">@xStock</td>
                                <td class="text-secondary pct-col">@xBond</td>

                                <td class="text-secondary">@xFees</td>
                                <td class="text-secondary">@xDraw</td>
                                <td class="text-secondary">@xChange</td>
                                <td class="text-secondary">@xDecReal</td>
                            </tr>

                            <!-- Labels after summary on top -->
                            <tr>
                                <th>Year</th>

                                <th>Jan</th>
                                <th>Alloc</th>

                                <th>Like</th>
                                <th>ROI Stock</th>
                                <th>ROI Bond</th>

                                <th>Fees</th>
                                <th>Withdrawal</th>
                                <th>Change</th>
                                <th>Dec</th>
                            </tr>

                            <!-- Details -->
                            @foreach (var y in iter.ByYear)
                            {
                                var jan       = $"{y.JanBalance.Round100():C0}";
                                var dec       = $"{y.DecBalance.Round100():C0}";

                                var alloc     = $"{y.JanStockPct * 100,2:F0}/{y.JanBondPct * 100,-2:F0}";
                                var fees      = 0 == y.Fees ? string.Empty : $"{y.Fees:C0}";
                                var draw      = $"{y.ActualWithdrawal:C0}";
                                var change    = 0 == y.Change ? string.Empty : $"{y.Change:C0}";
                                var stock     = 0 == y.StockROI? string.Empty : $"{y.StockROI:P1}".PadLeft(6);
                                var bond      = 0 == y.BondROI ? string.Empty : $"{y.BondROI:P1}".PadLeft(6);
                                var like      = 0 == y.LikeYear ? string.Empty : $"{y.LikeYear}";

                                var clsDraw   = y.ActualWithdrawal < y.PlannedWithdrawal ? "text-danger" : "";
                                var clsStock  = y.StockROI < 0.0 ? "pct-col text-danger" : "pct-col";
                                var clsBond   = y.BondROI < 0.0 ? "pct-col text-danger" : "pct-col";
                                var clsChange = y.Change < 0 ? "text-danger" : "";
                                var clsLike   = clsChange;

                                <tr>
                                    <td>@(y.Year + 1)</td>
                                    
                                    <td>@jan</td>
                                    <td>@alloc</td>

                                    <td class="@clsLike">@like</td>
                                    <td class="@clsStock">@stock</td>
                                    <td class="@clsBond">@bond</td>

                                    <td>@fees</td>
                                    <td class="@clsDraw">@draw</td>
                                    <td class="@clsChange">@change</td>
                                    <td>@dec</td>
                                </tr>
                            }

                        </tbody>
                    </table>
                    
                    <div>&nbsp;</div>
                </div>
            }
        </div>

        <div>
            <span><small class="text-secondary">Ver: @AppVersion</small></span>
        </div>
        <!-- scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

    </div>
</body>
</html>


@code
{
    [Parameter] public SimResult Model { get; set; } = null!;

    string AppVersion => typeof(Program).Assembly.GetName().Version?.ToString() ?? string.Empty;

    // We do not track year-by-year inflation.
    // We do not use inflation rate anywhere in calculations.
    // Making it a SimConfig parameter will send a wrong expectation.
    // Hard-coding here. Revisit.
    const double TheInflationRate = 0.03;

    // List of percentiles and their labels
    // Chosen perentiles are called out in the report.
    const double TargetPctl = 0.2;
    static readonly double[] PercentileTargets = [0.01, 0.05, 0.10, 0.20, 0.50, 0.80, 0.90];
    static readonly string[] PercentileSentiments = ["Disaster", "Unlucky", "Unfortunate", "Target", "Coin-flip", "Fortunate", "Lucky"];

    double InitialBalance => Model.StartingBalance;
    double StockAllocationPct => Model.InitialAllocation;
    double BondAllocationPct => (1 - Model.InitialAllocation);
    int NumYears => Model.NoOfYears;
    int NumIterations => Model.Results.Count;

    IEnumerable<SimIteration> Results => Model.Results;
    IEnumerable<SimIteration> Failed => Model.Results.Where(x => !x.Success);
    IEnumerable<SimIteration> Survived => Model.Results.Where(x => x.Success);

    IEnumerable<FailureBucket> GetFailureBuckets()
    {
        var numBuckets = NumYears / 5;
        numBuckets += NumYears % 5 == 0 ? 0 : 1;

        for (int i = 0; i < numBuckets; i++)
        {
            var from = i * 5;
            var to = from + 5 - 1;
            var numFailed = Failed.Where(x => x.ByYear.Count - 1 >= from && x.ByYear.Count - 1 <= to).Count();
            yield return new(from, to, numFailed);
        }
    }

    SimIteration FindIterationByPercentile(double percentile) => Model.Results[GetPercentileIndex(Model.Results.Count, percentile)];

    static int GetPercentileIndex(int length, double percentile) => 0.0 == percentile ? 0 : 1.0 == percentile ? length - 1 : Math.Max((int)(length * percentile) - 1, 0);

    static (string pctlLabel, string pctlId) GetPercentileLabelAndId(double percentil)
    {
        var pct100 = (int)(percentil * 100);

        return (
            pctlLabel: 1 == pct100 ? "1st" : 2 == pct100 ? "2nd" : 3 == pct100 ? "3rd" : $"{pct100}th",
            pctlId: $"pctl{pct100:00}"
        );
    }

    record FailureBucket(int From, int To, int NumFailed);
}