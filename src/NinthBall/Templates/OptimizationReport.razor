@using System;

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Optimization Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body>
    <div class="container-fluid">
        <h2 class="mt-3">Optimization Results</h2>

        <!-- Problem Summary -->
        <div class="mt-3">
            <h4>Search Space</h4>
            <ul>
                @foreach (var variable in Model.Problem.SearchVariables)
                {
                    var (min, max) = Model.Problem.SearchRanges[variable];
                    var step = Model.Problem.StepSizes[variable];
                    <li>@variable: @FormatSearchSpaceValue(variable, min) to @FormatSearchSpaceValue(variable, max), step @FormatSearchSpaceValue(variable, step)</li>
                }
            </ul>

            <h4>Ratings</h4>
            <ul>
                @foreach (var rating in Model.Problem.Ratings)
                {
                    <li>@rating.ToString()</li>
                }
            </ul>

            <p><strong>Total evaluations:</strong> @Model.TotalEvaluations</p>
            <p><strong>Pareto-optimal solutions:</strong> @Model.ParetoFront.Count</p>
        </div>

        <!-- Top Solutions Table -->
        <h3 class="mt-4">Top Solutions</h3>
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th>#</th>
                    @foreach (var variable in Model.Problem.SearchVariables)
                    {
                        <th>@variable</th>
                    }
                    @foreach (var rating in Model.Problem.Ratings)
                    {
                        <th>@rating.Name</th>
                    }
                    <th>Survival Rate</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int index = 1;
                }
                @foreach (var solution in GetTopSolutions())
                {
                    <tr>
                        <td>@index</td>
                        @foreach (var variable in Model.Problem.SearchVariables)
                        {
                            var value = solution.Inputs[variable];
                            <td>@FormatValue(variable, value)</td>
                        }
                        @foreach (var rating in Model.Problem.Ratings)
                        {
                            var score = solution.Result.Scores[rating.Name];
                            var cssClass = score.Value >= 8.0 ? "text-success" : score.Value >= 5.0 ? "text-warning" : "text-danger";
                            <td class="@cssClass">@score</td>
                        }
                        <td>@solution.Result.SurvivalRate.ToString("P1")</td>
                    </tr>
                    index++;
                }
            </tbody>
        </table>

        <!-- Tabbed Details for Top Solutions -->
        <div class="mt-4">
            <ul class="nav" role="tablist">
                <li class="nav-item">
                    <a class="nav-link disabled" aria-disabled="true">Solution Details: </a>
                </li>
                @{
                    int tabIndex = 1;
                }
                @foreach (var solution in GetTopSolutions())
                {
                    var tabId = $"solution{tabIndex}";
                    var isActive = tabIndex == 1 ? "active" : "";

                    <li class="nav-item">
                        <a class="nav-link @isActive" data-bs-toggle="tab" href="#@tabId">Solution @tabIndex</a>
                    </li>
                    tabIndex++;
                }
            </ul>

            <div class="tab-content">
                @{
                    int contentIndex = 1;
                }
                @foreach (var solution in GetTopSolutions())
                {
                    var tabId = $"solution{contentIndex}";
                    var isActive = contentIndex == 1 ? "active" : "";

                    <div class="tab-pane @isActive" id="@tabId">
                        <hr />
                        <h3>Solution #@contentIndex</h3>
                        <SimDetails Model="solution.Result" />
                    </div>
                    contentIndex++;
                }
            </div>
        </div>

        <div class="mt-3">
            <small class="text-secondary">Ver: @AppVersion</small>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>
</html>

@code {
    [Parameter] public OptimizationResult Model { get; set; } = null!;

    string AppVersion => typeof(Program).Assembly.GetName().Version?.ToString() ?? string.Empty;

    List<Solution> GetTopSolutions()
    {
        return Model.ParetoFront
            .OrderByDescending(s => s.Result.SurvivalRate)
            .Take(10)
            .ToList();
    }

    string FormatValue(SimVariable variable, double value)
    {
        return variable switch
        {
            SimVariable.StartingBalance => value.ToString("C0"),
            SimVariable.WithdrawalRate => value.ToString("P2"),
            SimVariable.StockAllocation => value.ToString("P0"),
            _ => value.ToString("F2")
        };
    }

    string FormatSearchSpaceValue(SimVariable variable, double value)
    {
        return variable switch
        {
            SimVariable.StartingBalance => value.ToString("C0"),
            SimVariable.WithdrawalRate => value.ToString("P2"),
            SimVariable.StockAllocation => value.ToString("P0"),
            _ => value.ToString("F0")
        };
    }
}
